@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@model FitnessCenter.Models.Appointment

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        @TempData["Error"]
    </div>
}

<div class="d-flex justify-content-center align-items-center vh-100" style="background: linear-gradient(to right, #8360c3, #2ebf91);">
    <div class="card shadow-lg border-0" style="width: 100%; max-width: 900px; border-radius: 20px; overflow: hidden;">
        <div class="card-header text-white text-center" style="background: #2ebf91;">
            <h3 class="mb-0">Book an Appointment</h3>
        </div>
        <div class="card-body p-5">
            <form asp-controller="Appointment" asp-action="Create" method="post">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <label asp-for="TrainingProgram.Gym.GymId" class="form-label">Gym</label>
                        <select asp-for="TrainingProgram.Gym.GymId" class="form-select shadow" asp-items="ViewBag.Gyms" id="gymId">
                            <option value="">-- Select Gym --</option>
                        </select>
                        <span asp-validation-for="TrainingProgram.Gym.GymId" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="TrainingProgramId" class="form-label">TrainingProgram</label>
                        <select asp-for="TrainingProgramId" class="form-select shadow" id="trainingprogramId">
                            <option value="">-- Select Training Program --</option>
                        </select>
                        <span asp-validation-for="TrainingProgramId" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="CoachId" class="form-label">Coach</label>
                        <select asp-for="CoachId" class="form-select shadow" id="coachId">
                            <option value="">-- Select Coach --</option>
                        </select>
                        <span asp-validation-for="CoachId" class="text-danger"></span>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow text-center py-3">
                            <h5 class="text-muted">Price</h5>
                            <p id="trainingprogramPrice" class="h4 text-primary">--</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow text-center py-3">
                            <h5 class="text-muted">Duration</h5>
                            <p id="trainingprogramDuration" class="h4 text-primary">--</p>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label asp-for="AppointmentDate" class="form-label">Date</label>
                        <input asp-for="AppointmentDate" type="date" class="form-control shadow" id="appointmentDate" />
                        <span asp-validation-for="AppointmentDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label for="appointmentTime" class="form-label">Time</label>
                        <select id="appointmentTime" name="appointmentTime" class="form-select shadow" disabled>
                            <option value="">-- Select Date First --</option>
                        </select>
                    </div>
                </div>

                <input asp-for="AppointmentDate" type="hidden" id="completeAppointmentDateTime" />

                <div class="d-flex justify-content-center gap-3 mt-4">
                    <button type="submit" class="btn btn-lg text-white" style="background: #8360c3; border: none; border-radius: 30px; padding: 10px 30px;">
                        Book Appointment
                    </button>
                    <a asp-controller="Home" asp-action="Index" class="btn btn-lg text-white" style="background: #2ebf91; border: none; border-radius: 30px; padding: 10px 30px;">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const gymSelect = document.getElementById('gymId');
            const trainingprogramSelect = document.getElementById('trainingprogramId');
            const coachSelect = document.getElementById('coachId');
            const trainingprogramPriceElement = document.getElementById('trainingprogramPrice');
            const trainingprogramDurationElement = document.getElementById('trainingprogramDuration');
            const dateInput = document.getElementById('appointmentDate');
            const timeSelect = document.getElementById('appointmentTime');

            let programsData = [];

            function formatPrice(price) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(price);
            }

            function formatDuration(minutes) {
                if (minutes < 60) return `${minutes} minutes`;
                const hours = Math.floor(minutes / 60);
                const m = minutes % 60;
                return `${hours} hour${hours>1?'s':''}${m ? ' ' + m + ' minutes' : ''}`;
            }

            function setDefaultOption(selectElement, text = '-- Select --') {
                selectElement.innerHTML = '';
                const opt = document.createElement('option');
                opt.value = '';
                opt.text = text;
                selectElement.add(opt);
            }

            // When gym changes → load training programs
            gymSelect.addEventListener('change', async function () {
                const gymId = this.value;

                if (!gymId) {
                    setDefaultOption(trainingprogramSelect, '-- Select Training Program --');
                    setDefaultOption(coachSelect, '-- Select Coach --');
                    trainingprogramPriceElement.textContent = '--';
                    trainingprogramDurationElement.textContent = '--';
                    return;
                }

                const res = await fetch(`/Appointment/GetTrainingProgramsByGym?gymId=${gymId}`);
                programsData = await res.json();

                setDefaultOption(trainingprogramSelect, '-- Select Training Program --');
                programsData.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.trainingprogramId;
                    option.text = `${p.name} (${formatPrice(p.price)} - ${formatDuration(p.duration)})`;
                    trainingprogramSelect.add(option);
                });

                setDefaultOption(coachSelect, '-- Select Coach --');
                trainingprogramPriceElement.textContent = '--';
                trainingprogramDurationElement.textContent = '--';
            });

            // When training program changes → show price + duration + load coaches
            trainingprogramSelect.addEventListener('change', async function () {

                const selectedProgram = programsData.find(p => p.trainingprogramId == this.value);

                if (selectedProgram) {
                    trainingprogramPriceElement.textContent = formatPrice(selectedProgram.price);
                    trainingprogramDurationElement.textContent = formatDuration(selectedProgram.duration);
                } else {
                    trainingprogramPriceElement.textContent = '--';
                    trainingprogramDurationElement.textContent = '--';
                }

                const gymId = gymSelect.value;

                if (this.value && gymId) {
                    const res = await fetch(`/Appointment/GetCoachesByTrainingProgramAndGym?gymId=${gymId}&trainingprogramId=${this.value}`);
                    const coaches = await res.json();

                    setDefaultOption(coachSelect, '-- Select Coach --');
                    coaches.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.coachId;
                        opt.text = c.name;
                        coachSelect.add(opt);
                    });
                }

                setDefaultOption(timeSelect, '-- Select Coach and Date First --');
            });

            async function updateTimeSlots() {
                const coachId = coachSelect.value;
                const trainingprogramId = trainingprogramSelect.value;
                const date = dateInput.value;

                if (!coachId || !trainingprogramId || !date) {
                    setDefaultOption(timeSelect, '-- Select all fields above --');
                    timeSelect.disabled = true;
                    return;
                }

                const res = await fetch(`/Appointment/GetAvailableTimeSlots?coachId=${coachId}&date=${date}&trainingprogramId=${trainingprogramId}`);
                const slots = await res.json();

                setDefaultOption(timeSelect, '-- Select Time --');
                slots.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.time;
                    option.text = s.time;
                    timeSelect.add(option);
                });

                timeSelect.disabled = false;
            }

            coachSelect.addEventListener('change', updateTimeSlots);
            dateInput.addEventListener('change', updateTimeSlots);
        });
    </script>



   @*  <script>
        document.addEventListener('DOMContentLoaded', function () {
            const gymSelect = document.getElementById('gymId');
            const trainingprogramSelect = document.getElementById('trainingprogramId');
            const coachSelect = document.getElementById('coachId');
            const trainingprogramPriceElement = document.getElementById('trainingprogramPrice');
            const trainingprogramDurationElement = document.getElementById('trainingprogramDuration');
            const dateInput = document.getElementById('appointmentDate');
            const timeSelect = document.getElementById('appointmentTime');

            let programsData = [];

            function formatPrice(price) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(price);
            }

            function formatDuration(minutes) {
                if (minutes < 60) {
                    return `${minutes} minutes`;
                }
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return `${hours} hour${hours > 1 ? 's' : ''}${remainingMinutes ? ` ${remainingMinutes} minutes` : ''}`;
            }

            function setDefaultOption(selectElement, text = '-- Select --') {
                selectElement.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.text = text;
                defaultOption.value = '';
                selectElement.add(defaultOption);
            }

            async function updateTimeSlots() {
                const coachId = coachSelect.value;
                const trainingprogramId = trainingprogramSelect.value;
                const date = dateInput.value;

                if (!coachId || !trainingprogramId || !date) {
                    timeSelect.disabled = true;
                    setDefaultOption(timeSelect, '-- Select all fields above --');
                    return;
                }

                timeSelect.disabled = true;
                timeSelect.innerHTML = '<option value="">Loading...</option>';

                try {
                    const response = await fetch(`/Appointment/GetAvailableTimeSlots?coachId=${coachId}&date=${date}&trainingprogramId=${trainingprogramId}`);
                    if (!response.ok) throw new Error('Failed to fetch time slots');
                    const timeSlots = await response.json();

                    setDefaultOption(timeSelect, '-- Select Time --');
                    timeSlots.forEach(slot => {
                        const option = document.createElement('option');
                        const timeString = new Date(`2000-01-01T${slot.time}`).toLocaleTimeString([], {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        option.value = slot.time;
                        option.text = timeString;

                        if (!slot.isAvailable) {
                            option.disabled = true;
                            option.classList.add('text-muted', 'bg-light');
                        }

                        timeSelect.add(option);
                    });

                    timeSelect.disabled = false;
                } catch (error) {
                    console.error('Error fetching time slots:', error);
                    setDefaultOption(timeSelect, '-- Error loading time slots --');
                }
            }

            gymSelect.addEventListener('change', async function () {
                const gymId = this.value;
                if (gymId) {
                    try {
                        const response = await fetch(`/Appointment/GetTrainingProgramsByGym?gymId=${gymId}`);
                        if (!response.ok) throw new Error('Failed to fetch trainingprograms');
                        const data = await response.json();

                        trprogramsData = data;
                        setDefaultOption(trainingprogramSelect, '-- Select Training Program --');
                        data.forEach(trainingprogram => {
                            const option = document.createElement('option');
                            option.text = `${trainingprogram.name} (${formatPrice(trainingprogram.price)} - ${formatDuration(trainingprogram.duration)})`;
                            option.value = trainingprogram.trainingprogramId;
                            trainingprogramSelect.add(option);
                        });
                        setDefaultOption(coachSelect, '-- Select Coach --');
                        trainingprogramPriceElement.textContent = '--';
                        trainingprogramDurationElement.textContent = '--';
                    } catch (error) {
                        console.error('Error fetching trainingprograms:', error);
                        setDefaultOption(trainingprogramSelect, '-- No TrainingPrograms Available --');
                    }
                } else {
                    setDefaultOption(trainingprogramSelect, '-- Select TrainingProgram --');
                    setDefaultOption(coachSelect, '-- Select Coach --');
                    trainingprogramPriceElement.textContent = '--';
                    trainingprogramDurationElement.textContent = '--';
                }
            });

            trainingprogramSelect.addEventListener('change', async function () {
                const selectedProgram = trainingprogramsData.find(s => s.trainingprogramId == this.value);
                if (selectedProgram) {
                    trainingprogramPriceElement.textContent = formatPrice(selectedTrainingProgram.price);
                    trainingprogramDurationElement.textContent = formatDuration(selectedTrainingProgram.duration);
                } else {
                    trainingprogramPriceElement.textContent = '--';
                    trainingprogramDurationElement.textContent = '--';
                }

                const gymId = gymSelect.value;
                if (this.value && gymId) {
                    try {
                        const response = await fetch(`/Appointment/GetCoachesByTrainingProgramAndGym?gymId=${gymId}&trainingprogramId=${this.value}`);
                        if (!response.ok) throw new Error('Failed to fetch coaches');
                        const data = await response.json();

                        setDefaultOption(coachSelect, '-- Select Coach --');
                        data.forEach(coach => {
                            const option = document.createElement('option');
                            option.text = coach.name;
                            option.value = coach.coachId;
                            coachSelect.add(option);
                        });
                    } catch (error) {
                        console.error('Error fetching coaches:', error);
                        setDefaultOption(coachSelect, '-- No Coaches Available --');
                    }
                } else {
                    setDefaultOption(coachSelect, '-- Select Coach --');
                }

                setDefaultOption(timeSelect, '-- Select Coach and Date First --');
            });

            if (dateInput) {
                const today = new Date();
                const maxDate = new Date();
                maxDate.setMonth(maxDate.getMonth() + 3);

                dateInput.min = today.toISOString().split('T')[0];
                dateInput.max = maxDate.toISOString().split('T')[0];
            }

            coachSelect.addEventListener('change', updateTimeSlots);
            dateInput.addEventListener('change', updateTimeSlots);
        });
    </script> *@
}
