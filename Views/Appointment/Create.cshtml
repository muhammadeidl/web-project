@using FitnessCenter.Models
@model FitnessCenter.Models.Appointment

@{
    ViewData["Title"] = "Book Appointment";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        @TempData["Error"]
    </div>
}

<div class="d-flex justify-content-center align-items-center vh-100" style="background: linear-gradient(to right, #8360c3, #2ebf91);">
    <div class="card shadow-lg border-0" style="width: 100%; max-width: 900px; border-radius: 20px; overflow: hidden;">
        <div class="card-header text-white text-center" style="background: #2ebf91;">
            <h3 class="mb-0">Book an Appointment</h3>
        </div>

        <div class="card-body p-5">
            <form asp-controller="Appointment" asp-action="Create" method="post">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <div class="row mb-4">
                    <!-- ✅ Gym (: name="gymId"  asp-for) -->
                    <div class="col-md-4">
                        <label class="form-label">Gym</label>
                        <select name="gymId" class="form-select shadow" asp-items="ViewBag.Gyms" id="gymId">
                            <option value="">-- Select Gym --</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="TrainingProgramId" class="form-label">Training Program</label>
                        <select asp-for="TrainingProgramId" class="form-select shadow" id="trainingprogramId">
                            <option value="">-- Select Training Program --</option>
                        </select>
                        <span asp-validation-for="TrainingProgramId" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="CoachId" class="form-label">Coach</label>
                        <select asp-for="CoachId" class="form-select shadow" id="coachId">
                            <option value="">-- Select Coach --</option>
                        </select>
                        <span asp-validation-for="CoachId" class="text-danger"></span>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow text-center py-3">
                            <h5 class="text-muted">Price</h5>
                            <p id="trainingprogramPrice" class="h4 text-primary">--</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow text-center py-3">
                            <h5 class="text-muted">Duration</h5>
                            <p id="trainingprogramDuration" class="h4 text-primary">--</p>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label asp-for="AppointmentDate" class="form-label">Date</label>
                        <input asp-for="AppointmentDate" type="date" class="form-control shadow" id="appointmentDate" />
                        <span asp-validation-for="AppointmentDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label for="appointmentTime" class="form-label">Time</label>
                        <select id="appointmentTime" name="appointmentTime" class="form-select shadow" disabled>
                            <option value="">-- Select Date First --</option>
                        </select>
                    </div>
                </div>

                <!-- ✅  hidden  ( Model Binding) -->

                <div class="d-flex justify-content-center gap-3 mt-4">
                    <button type="submit" class="btn btn-lg text-white" style="background: #8360c3; border: none; border-radius: 30px; padding: 10px 30px;">
                        Book Appointment
                    </button>
                    <a asp-controller="Home" asp-action="Index" class="btn btn-lg text-white" style="background: #2ebf91; border: none; border-radius: 30px; padding: 10px 30px;">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            const gymSelect = document.getElementById('gymId');
            const trainingprogramSelect = document.getElementById('trainingprogramId');
            const coachSelect = document.getElementById('coachId');
            const trainingprogramPriceElement = document.getElementById('trainingprogramPrice');
            const trainingprogramDurationElement = document.getElementById('trainingprogramDuration');
            const dateInput = document.getElementById('appointmentDate');
            const timeSelect = document.getElementById('appointmentTime');

            let programsData = [];

            function formatPrice(price) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(price);
            }

            function formatDuration(minutes) {
                if (minutes < 60) return `${minutes} minutes`;
                const hours = Math.floor(minutes / 60);
                const m = minutes % 60;
                return `${hours} hour${hours > 1 ? 's' : ''}${m ? ' ' + m + ' minutes' : ''}`;
            }

            function setDefaultOption(selectElement, text = '-- Select --') {
                selectElement.innerHTML = '';
                const opt = document.createElement('option');
                opt.value = '';
                opt.text = text;
                selectElement.add(opt);
            }

            // 1) Gym change -> load programs
            gymSelect.addEventListener('change', async function () {
                const gymId = this.value;

                setDefaultOption(trainingprogramSelect, '-- Select Training Program --');
                setDefaultOption(coachSelect, '-- Select Coach --');
                trainingprogramPriceElement.textContent = '--';
                trainingprogramDurationElement.textContent = '--';
                setDefaultOption(timeSelect, '-- Select Coach and Date First --');
                timeSelect.disabled = true;

                if (!gymId) return;

                const res = await fetch(`/Appointment/GetTrainingProgramsByGym?gymId=${gymId}`);
                programsData = await res.json();

                programsData.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.trainingProgramId;
                    option.text = p.name;
                    trainingprogramSelect.add(option);
                });
            });

            // 2) Program change -> show price/duration + load coaches
            trainingprogramSelect.addEventListener('change', async function () {
                const selectedProgram = programsData.find(p => p.trainingProgramId == this.value);

                if (selectedProgram) {
                    trainingprogramPriceElement.textContent = formatPrice(selectedProgram.price);
                    trainingprogramDurationElement.textContent = formatDuration(selectedProgram.duration);
                } else {
                    trainingprogramPriceElement.textContent = '--';
                    trainingprogramDurationElement.textContent = '--';
                }

                setDefaultOption(coachSelect, '-- Select Coach --');
                setDefaultOption(timeSelect, '-- Select Coach and Date First --');
                timeSelect.disabled = true;

                const gymId = gymSelect.value;
                if (!this.value || !gymId) return;

                const res = await fetch(`/Appointment/GetCoachesByTrainingProgramAndGym?gymId=${gymId}&trainingprogramId=${this.value}`);
                const coaches = await res.json();

                coaches.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.coachId;
                    opt.text = c.name;
                    coachSelect.add(opt);
                });
            });

            // 3) Update available time slots
            async function updateTimeSlots() {
                const coachId = coachSelect.value;
                const trainingprogramId = trainingprogramSelect.value;
                const date = dateInput.value;

                setDefaultOption(timeSelect, '-- Select Time --');
                timeSelect.disabled = true;

                if (!coachId || !trainingprogramId || !date) {
                    setDefaultOption(timeSelect, '-- Select all fields above --');
                    return;
                }

                const res = await fetch(`/Appointment/GetAvailableTimeSlots?coachId=${coachId}&date=${date}&trainingprogramId=${trainingprogramId}`);
                const slots = await res.json(); // ["09:00", "10:00"]

                if (!slots || slots.length === 0) {
                    setDefaultOption(timeSelect, '-- No slots available --');
                    return;
                }

                setDefaultOption(timeSelect, '-- Select Time --');
                slots.forEach(timeString => {
                    const option = document.createElement('option');
                    option.value = timeString;
                    option.text = timeString;
                    timeSelect.add(option);
                });

                timeSelect.disabled = false;
            }

            coachSelect.addEventListener('change', updateTimeSlots);
            dateInput.addEventListener('change', updateTimeSlots);
        });
    </script>
}
